<include file="Public:header" />
<style>
    *{margin:0;padding:0;}
    .fileControl{
        padding:5px;
    }
    .vqdTrigger{
        width:60px;
        height:25px;
        line-height:25px;
        text-align:center;
        border-radius:2px;
        background:#CC290E;
        color:#FFF;
        font-size:12px;
        border:none;
        cursor:pointer;
        outline:none;
    }
    #vqdfile{
        position:absolute;
        opacity:0;
    }
    .fileList li{
        position:relative;
        margin-top:5px;
        height:50px;
        padding:6px;
        display:block;
        border:1px solid #CCC;
        border-radius:4px;
    }
    .fileList li img{
        float:left;
        height:50px;
        display:block;
    }
    .fileList li .del{
        position:absolute;
        right:5px;
        top:20px;
        width:18px;
        height:18px;
        line-height:19px;
        text-align:center;
        border:1px solid #CCC;
        border-radius:20px;
        text-decoration:none;
        color:#888;
        font-size:16px;
    }
    #div_setting_2,#div_setting_3 {
        border:1px solid #dce3ed;
    }
    .col-tab ul.tabBut {
        bottom:-11px;
    }
    ul li{
        list-style:none;
    }
    .flyCheckBox{
        width:140px;
        height:35px;
        border:1px solid #CCC;
        border-radius:6px;
        cursor:pointer;
        background:#F4F4F4;
        outline:none;
        padding:0 5px;
        float:left;
    }
    .flyBox{
        position:fixed;
        left:25%;
        right:25%;
        top:10%;
        max-height:320px;
        overflow:hidden;
        z-index:1000;
        padding:10px 20px 45px 20px;
        border-radius:4px;
        background:#FFF;
        border:1px solid #CCC;
        display:none;
    }
    .flyBox label{
        margin-top:5px;
        padding-bottom:5px;
        width:100%;
        height:14px;
        line-height:14px;
        display:block;
        border-bottom:1px dashed #ccc;
    }
    .flyBox input[type='checkbox']{
        float:left;
        margin-right:5px;

    }
    #to_id{
        width:100%;
        height:100%;
        min-height:200px;
        max-height:250px;
        overflow:scroll;
        overflow-x:hidden;
    }
    .flyBox .foot{
        width:100%;
        padding:10px 0;
        height:21px;
        text-align:center;
        position:absolute;
        bottom:0;
        left:0;
        background:#f4f4f4;
    }
    .flyBox .head{
        margin-bottom:20px;
        width:100%;
        height:21px;
    }
    .flyBox .flyBox_close{
        font-size:16px;
        float:right;
        text-decoration:none;
    }
    .flyBox .iframe{

    }
    .chk_submit .chk_reset{
        width:60px;
        height:22px;
        background:#CCC;
        border:1px solid #CCC;
        border-radius:2px;
        display:inline-block;
        cursor:pointer;
    }
    .flyBox_trigger{
        width:60px;
        height:37px;
        margin-right:10px;
        float:left;
        border-radius:4px;
        border:1px solid #CCC;
        background:#f4f4f4;
        text-align:center;
        cursor:pointer;
        color:#555;
    }
</style>
<link rel="stylesheet" type="text/css" href="__ROOT__/statics/admin/css/jquery.datetimepicker.css"/>
<script type="text/javascript" src="__ROOT__/statics/admin/js/jquery.datetimepicker.js"></script>
<script type="text/javascript" src="__ROOT__/statics/js/jquery/plugins/jquery.imagePreview.js"></script>
<script src="__ROOT__/statics/lib/uploadify/jquery.uploadify.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="__ROOT__/statics/lib/uploadify/uploadify.css">
<script src="__ROOT__/statics/admin/js/jquerysession.js"></script>


<style>
    .groupChoice{
        position:fixed;
        width:80%;
        left:10%;
        top:50px;
        height:388px;
        background:#fff;
        z-index:288;
        display:none;
        border:1px solid #ccc;
    }
    .fullscreen_shadow{
        position:fixed;
        left:0;
        top:0;
        bottom:0;
        right:0;
        background:rgba(0,0,0,0.5);
        width:100%;
        height:100%;
        z-index:266;
        display:none;
    }
    .groupChoice .iframe{
        border:none;
        width:100%;
        height:350px;
    }
    .groupChoice .control{
        width:100%;
        height:38px;
        text-align:center;
    }
    /* 列表隐藏的列 */
    .hideprice input,.hidestock input{
        border:none;
        background:none;
        width:80px;
        height:32px;
        line-height:32px;
        text-align:center;
        border:1px solid #ccc;
        outline:none;
    }
    .readonlyStyle{
        background:#f4f4f4;
        border:1px solid #CCC;
    }
</style>


<div style="padding:10px">
    <div class="col-tab">
        <form action="admin.php?m=Everydaynews&a=add" method="post" name="myform" id="myform" enctype="multipart/form-data" style="margin-top:10px;">
            <div id="div_setting_1" class="contentList pad-10">
                <table width="100%" cellpadding="2" cellspacing="1" class="table_form">
                    <!-- 关联商品SPU -->
                    <input type="hidden" name="spu" id="spu" value="{$data.spu_id}" />
                    <input type="hidden" name="rid" id="rid" value="{$data.rid}" />

                    <tbody id="item_body">
                        <tr>
                            <td>上架时间 :</td>
                            <td>
                                <input type="text" name="time_start" id="time_start" class="date datetimepicker" size="20" value="{$data.time_start}">
                            </td>
                        </tr>
                        <tr>
                            <td>下架时间 :</td>
                            <td>
                                <input type="text" name="time_end" id="time_end" class="date datetimepicker" size="20" value="{$data.end_start}">
                            </td>
                        </tr>
                        <tr>
                            <td width="150">商品宽屏配图</br>(建议分辨率:612×340) :</td>
                            <td>
                                <form>
                                    <div id="queue"></div>
                                    <input id="file_upload" name="file_upload" type="file" multiple="true">
                                    <input type="hidden" name="image_src" id="image_src" value="" />
                                    <div class="image_box">
                                        <notempty name="data.image_src">
                                            <img src="{$data.image_src}" style="width:120px;border:1px solid #ccc;padding:1px;display:block;" />
                                        </notempty>
                                    </div>
                                </form>
                                <script type="text/javascript">
                                    $(function() {
                                        $('#file_upload').uploadify({
                                            'formData'     : {
                                                'timestamp' : '{$timestamp}',
                                                'token'     : '{$token}'
                                            },
                                            'swf'      : '__ROOT__/statics/lib/uploadify/uploadify.swf',
                                            'uploader' : '__ROOT__/statics/lib/uploadify/uploadify.php',
                                            'fileTypeExts'	  : '*.jpg; *.png; *.gif;',
                                            'onUploadSuccess' : function(file, data, response) {
                                                var data = $.parseJSON(data);
                                                var src = '';
                                                if(response){
                                                    src = '__ROOT__/upload/temp/' + file.name;
                                                    $("#image_src").val(src);
                                                    $(".image_box").html('<img src="'+src+'" style="width:120px;border:1px solid #ccc;padding:1px;display:block;" />')
                                                }
                                            }
                                        });
                                    });
                                </script>
                            </td>
                        </tr>
                        <tr>
                            <td>活动顺序 :</td>
                            <td>
                                <input type="text" name="sort" id="sort" value="{$data.sort}" />
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="table-list" id="skulist">
                    <table width="100%" cellspacing="0" class="tb_rec">
                        <thead>
                        <tr>
                            <th align="center">商品编号</th>
                            <th align="center">商品标题</th>
                            <th align="center">商品图片</th>
                            <th align="center">分类</th>
                            <th align="center">SKU</th>
                            <th align="center">价格(元)</th>
                            <th align="center">销量(件)</th>
                            <th align="center">库存(件)</th>
                            <th align="center">活动价格(元)</th>
                            <th align="center">活动库存(件)</th>
                        </tr>
                        </thead>
                        <tbody>
                            <tr>
                            <td rowspan="{$data.spu_len}" align="center">{$data.spu_id}</td>
                            <td rowspan="{$data.spu_len}" align="center" width="188">{$data.spu_title}</td>
                            <td rowspan="{$data.spu_len}" align="center"><img src="{$data.spu_img}" width="80" /></td>
                            <td rowspan="{$data.spu_len}" align="center">{$data.spu_cate}</td>
                            <volist name="exlist" id="eval">
                                <if condition="$i neq 1"><tr></if>
                                <!--淘客标识-->
                                <td align="center" class="hideskuid" data-id="{$eval.id}" data-type="{$eval.type}" data-taoke="{$eval.taoke}">{$eval.sku}</td>
                                <td align="center" class="normalprice">{$eval.price}</td>
                                <td align="center">{$eval.sale}</td>
                                <td align="center">{$eval.stock}</td>

                                <!--无活动-->
                                <if condition="$eval.type eq '0'" >
                                    <td align="center">无</td>
                                    <td align="center">无</td>
                                <!--限时-->
                                <elseif condition="$eval.type eq '1'" />
                                    <switch name="eval.taoke">
                                        <case value="no">
                                            <td class="hideprice" align="center"><input type="text" value="{$eval.ex_price}" readonly="readonly" style="background:#F4f4f4;border:1px solid #ccc;" /></td>
                                            <td></td>
                                        </case>
                                        <case value="yes">
                                            <td class="hideprice" align="center"><input type="text" value="{$eval.ex_price}" readonly="readonly" style="background:#F4f4f4;border:1px solid #ccc;" /></td>
                                            <td></td>
                                        </case>
                                    </switch>
                                    <!--限时限量-->
                                <elseif condition="$eval.type eq '2'" />
                                    <switch name="eval.taoke">
                                        <case value="no">
                                            <td class="hideprice" align="center"><input type="text" value="{$eval.ex_price}" readonly="readonly" style="background:#F4f4f4;border:1px solid #ccc;" /></td>
                                            <td class="hidestock" align="center"><input type="text" value="{$eval.ex_stock}" readonly="readonly" style="background:#F4f4f4;border:1px solid #ccc;" /></td>
                                        </case>
                                        <case value="yes">
                                            <td class="hideprice" align="center"><input type="text" value="{$eval.ex_price}" readonly="readonly" style="background:#F4f4f4;border:1px solid #ccc;" /></td>
                                            <td class="hidestock" align="center"><input type="text" value="{$eval.ex_stock}" readonly="readonly" style="background:#F4f4f4;border:1px solid #ccc;" /></td>
                                        </case>
                                    </switch>
                                </if>
                                </tr>
                            </volist>
                        </tbody>
                    </table>
                </div>
                <div class="bk15"></div>
                <div class="btn"><input type="button" value="{$Think.lang.submit}" name="dosubmit" class="button" id="dosubmit"></div>
            </div>
        </div>
    </form>

</div>
<script type="text/javascript">
    var submitLock = true;

    Date.prototype.format = function(format) {
        var date = {
            "M+": this.getMonth() + 1,
            "d+": this.getDate(),
            "h+": this.getHours(),
            "m+": this.getMinutes(),
            "s+": this.getSeconds(),
            "q+": Math.floor((this.getMonth() + 3) / 3),
            "S+": this.getMilliseconds()
        };
        if (/(y+)/i.test(format)) {
            format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
        }
        for (var k in date) {
            if (new RegExp("(" + k + ")").test(format)) {
                format = format.replace(RegExp.$1, RegExp.$1.length == 1
                        ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
            }
        }
        return format;
    }

    $(function(){

        //表单提交
        $("#dosubmit").on("click",function(){
            var rid = $("#rid").val();
            var choiceTimeStart = $("#time_start").val();
            var choiceTimeEnd = $("#time_end").val();
            var choiceTimestampStart = Date.parse(choiceTimeStart)/1000;
            var choiceTimestampEnd = Date.parse(choiceTimeEnd)/1000;
            var nowTimestamp = Date.parse(new Date())/1000;

            if(!$("#spu").val()) {
                alert("请选择活动商品！");
                return false;
            }
            if(!choiceTimeStart) {
                alert("请选择上架时间！");
                return false;
            }
            if(!choiceTimeEnd) {
                alert("请选择下架时间！");
                return false;
            }
//            if(choiceTimestampStart < nowTimestamp) {
//                alert("发布时间不可小于当前时间！");
//                return false;
//            }
            if(choiceTimestampEnd < choiceTimestampStart) {
                alert("下架时间不可小于发布时间！");
                return false;
            }
            if(choiceTimestampEnd < nowTimestamp) {
                alert("下架时间不可小于当前时间！");
                return false;
            }
            var listdataArr = [];
            //验证库存和价格为0的情况
            var notempty = true;
            $("#skulist tbody tr").each(function(i){
                typeVal = $(this).find(".hideskuid").attr("data-type");
                exprice = $(this).find(".hideprice input[type='text']").val();
                exstock = $(this).find(".hidestock input[type='text']").val();
                //限时限量要验库存
                if(typeVal == '1') {
                    //限时验活动价
                    if (exprice == '0') {
                        alert("活动价格不能为0");
                        notempty = false;
                        return false;
                    }
                    //限时限量要验库存
                    if (typeVal == '2') {
                        if (exstock == '0') {
                            alert("活动库存不能为0");
                            notempty = false;
                            return false;
                        }
                    }
                }
                listdataArr.push({
                    id    : $(this).find(".hideskuid").attr("data-id"),
                    stock : $(this).find(".hidestock input[type='text']").val(),
                    price : $(this).find(".hideprice input[type='text']").val(),
                    type  : $(this).find(".hideskuid").attr("data-type"),
                    //淘客标识
                    taoke : $(this).find(".hideskuid").attr("data-taoke")
                })
            });
            if(!notempty) {
                return false;
            }
            var addData ={
                rid : rid,
                spu : $("#spu").val(),
                time_start : $("#time_start").val(),
                time_end : $("#time_end").val(),
                sort : $("#sort").val(),
                image_src : $("#image_src").val(),
                collection : listdataArr
            };
            if(submitLock) {
                submitLock = false;
                $.ajax({
                    type: "POST",
                    url: "admin.php?m=Everydaynews&a=save",
                    data: addData,
                    dataType: "json",
                    success: function (d) {
                        alert(d.msg);
                        //submitLock = true;
                        if (d.flag) {
                            window.location.href = "admin.php?m=Everydaynews&a=index";
                        }
                    },
                    error : function(){
                        submitLock = true;
                    }
                })
            }
        })


        $('.datetimepicker').datetimepicker({value:'',step:"30"});
    })
</script>
</body>
</html>