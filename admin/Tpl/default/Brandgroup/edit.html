<include file="Public:header" />
<style>
    *{margin:0;padding:0;}
    .fileControl{
        padding:5px;
    }
    .vqdTrigger{
        width:60px;
        height:25px;
        line-height:25px;
        text-align:center;
        border-radius:2px;
        background:#CC290E;
        color:#FFF;
        font-size:12px;
        border:none;
        cursor:pointer;
        outline:none;
    }
    #vqdfile{
        position:absolute;
        opacity:0;
    }
    .fileList li{
        position:relative;
        margin-top:5px;
        height:50px;
        padding:6px;
        display:block;
        border:1px solid #CCC;
        border-radius:4px;
    }
    .fileList li img{
        float:left;
        height:50px;
        display:block;
    }
    .fileList li .del{
        position:absolute;
        right:5px;
        top:20px;
        width:18px;
        height:18px;
        line-height:19px;
        text-align:center;
        border:1px solid #CCC;
        border-radius:20px;
        text-decoration:none;
        color:#888;
        font-size:16px;
    }
    #div_setting_2,#div_setting_3 {
        border:1px solid #dce3ed;
    }
    .col-tab ul.tabBut {
        bottom:-11px;
    }
    ul li{
        list-style:none;
    }
    .flyCheckBox{
        width:140px;
        height:35px;
        border:1px solid #CCC;
        border-radius:6px;
        cursor:pointer;
        background:#F4F4F4;
        outline:none;
        padding:0 5px;
        float:left;
    }
    .flyBox{
        position:fixed;
        left:25%;
        right:25%;
        top:10%;
        max-height:320px;
        overflow:hidden;
        z-index:1000;
        padding:10px 20px 45px 20px;
        border-radius:4px;
        background:#FFF;
        border:1px solid #CCC;
        display:none;
    }
    .flyBox label{
        margin-top:5px;
        padding-bottom:5px;
        width:100%;
        height:14px;
        line-height:14px;
        display:block;
        border-bottom:1px dashed #ccc;
    }
    .flyBox input[type='checkbox']{
        float:left;
        margin-right:5px;

    }
    #to_id{
        width:100%;
        height:100%;
        min-height:200px;
        max-height:250px;
        overflow:scroll;
        overflow-x:hidden;
    }
    .flyBox .foot{
        width:100%;
        padding:10px 0;
        height:21px;
        text-align:center;
        position:absolute;
        bottom:0;
        left:0;
        background:#f4f4f4;
    }
    .flyBox .head{
        margin-bottom:20px;
        width:100%;
        height:21px;
    }
    .flyBox .flyBox_close{
        font-size:16px;
        float:right;
        text-decoration:none;
    }
    .flyBox .iframe{

    }
    .chk_submit .chk_reset{
        width:60px;
        height:22px;
        background:#CCC;
        border:1px solid #CCC;
        border-radius:2px;
        display:inline-block;
        cursor:pointer;
    }
    .flyBox_trigger{
        width:60px;
        height:37px;
        margin-right:10px;
        float:left;
        border-radius:4px;
        border:1px solid #CCC;
        background:#f4f4f4;
        text-align:center;
        cursor:pointer;
        color:#555;
    }
</style>
<link rel="stylesheet" type="text/css" href="__ROOT__/statics/admin/css/jquery.datetimepicker.css"/>
<script type="text/javascript" src="__ROOT__/statics/admin/js/jquery.datetimepicker.js"></script>
<script type="text/javascript" src="__ROOT__/statics/js/jquery/plugins/jquery.imagePreview.js"></script>
<script src="__ROOT__/statics/lib/uploadify/jquery.uploadify.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="__ROOT__/statics/lib/uploadify/uploadify.css">
<script src="__ROOT__/statics/admin/js/jquerysession.js"></script>


<style>
    .groupChoice{
        position:fixed;
        width:80%;
        left:10%;
        top:50px;
        height:388px;
        background:#fff;
        z-index:288;
        display:none;
        border:1px solid #ccc;
    }
    .fullscreen_shadow{
        position:fixed;
        left:0;
        top:0;
        bottom:0;
        right:0;
        background:rgba(0,0,0,0.5);
        width:100%;
        height:100%;
        z-index:266;
        display:none;
    }
    .groupChoice .iframe{
        border:none;
        width:100%;
        height:350px;
    }
    .groupChoice .control{
        width:100%;
        height:38px;
        text-align:center;
    }
    /* 列表隐藏的列 */
    .hideprice input,.hidestock input{
        border:none;
        background:none;
        display:block;
        width:90%;
        height:20px;
        line-height:20px;
        text-align:center;
        border:1px solid #ccc;
        outline:none;
        padding:0;
    }
    .readonlyStyle{
        background:#f4f4f4;
        border:1px solid #CCC;
    }
    .row10{
        width:100%;
        height:25px;
    }
    .col2{
        width:16%;
        float:left;
        height:25px;
    }
</style>


<div style="padding:10px">
    <div class="col-tab">
        <form action="admin.php?m=Brandgroup&a=add" method="post" name="myform" onsubmit="return submitOnce(this)" id="myform" enctype="multipart/form-data" style="margin-top:10px;">
            <div id="div_setting_1" class="contentList pad-10">
                <table width="100%" cellpadding="2" cellspacing="1" class="table_form">
                    <!-- 关联商品SPU -->
                    <input type="hidden" name="spu" id="spu" value="{$data.spu_id}" />
                    <input type="hidden" name="rid" id="rid" value="{$data.rid}" />
                    <input type="hidden" name="type" id="type" value="{$type}" />
                    <input type="hidden" name="activeType" id="activeType" value="{$active_type}" />
                    <input type="hidden" name="activeBrandId" id="activeBrandId" value="{$active_brandId}" />
                    <tbody id="item_body">
                        <tr>
                            <td width="100">品牌团标题 :</td>
                            <td>
                                <input type="text" name="title" id="title" value="{$data.title}">
                            </td>
                        </tr>
                        <tr>
                            <td width="100">品牌团副标题 :</td>
                            <td>
                                <input type="text" name="desc" id="desc" value="{$data.provider}">
                            </td>
                        </tr>
                        <tr>
                            <td width="100">折扣信息 :</td>
                            <td>
                                <input type="text" name="provider" id="provider" value="{$data.desc}">
                            </td>
                        </tr>
                        <tr>
                            <td>上架时间 :</td>
                            <td>
                                <input type="text" name="time_start" id="time_start" class="date datetimepicker" size="20" value="{$data.time_start}">
                            </td>
                        </tr>
                        <tr>
                            <td>下架时间 :</td>
                            <td>
                                <input type="text" name="time_end" id="time_end" class="date datetimepicker" size="20" value="{$data.end_start}">
                            </td>
                        </tr>
                        <tr>
                            <td width="150">商品宽屏配图</br>(建议分辨率:612×250) :</td>
                            <td>
                                <form>
                                    <div id="queue"></div>
                                    <input id="file_upload" name="file_upload" type="file" multiple="true">
                                    <input type="hidden" name="image_src" id="image_src" value="" />
                                    <div class="image_box">
                                        <notempty name="data.image_src">
                                            <img src="{$data.image_src}" style="width:120px;border:1px solid #ccc;padding:1px;display:block;" />
                                        </notempty>
                                    </div>
                                </form>
                                <script type="text/javascript">
                                    $(function() {
                                        $('#file_upload').uploadify({
                                            'formData'     : {
                                                'timestamp' : '{$timestamp}',
                                                'token'     : '{$token}'
                                            },
                                            'swf'      : '__ROOT__/statics/lib/uploadify/uploadify.swf',
                                            'uploader' : '__ROOT__/statics/lib/uploadify/uploadify.php',
                                            'fileTypeExts'	  : '*.jpg; *.png; *.gif;',
                                            'onUploadSuccess' : function(file, data, response) {
                                                var data = $.parseJSON(data);
                                                var src = '';
                                                if(response){
                                                    src = '__ROOT__/upload/temp/' + file.name;
                                                    $("#image_src").val(src);
                                                    $(".image_box").html('<img src="'+src+'" style="width:120px;border:1px solid #ccc;padding:1px;display:block;" />')
                                                }
                                            }
                                        });
                                    });
                                </script>
                            </td>
                        </tr>
                        <tr>
                            <td>活动顺序 :</td>
                            <td>
                                <input type="text" name="sort" id="sort" value="{$data.sort}" />
                            </td>
                        </tr>
                    </tbody>
                </table>
                <input type="button" class="flyBox_trigger" style="margin:10px 0;" id="select_group" value="添加商品" data-type="timelimit" />
                <div style="clear:both;"></div>
                <div class="table-list" id="skulist">
                    <table width="100%" cellspacing="0" class="tb_rec">
                        <thead>
                        <tr>
                            <th align="center">操作</th>
                            <th align="center">商品编号</th>
                            <th align="center" width="150">商品标题</th>
                            <th align="center">商品图片</th>
                            <th align="center">分类</th>
                            <th align="center">排序</th>
                            <th align="center">SKU</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="bk15"></div>
                <div class="btn"><input type="button" value="{$Think.lang.submit}" name="dosubmit" class="button" id="dosubmit"></div>
            </div>
        </form>
    </div>
</div>

<div class="fullscreen_shadow"></div>
<div class="selectGoods">
    <div class="search">
        <table width="100%" cellspacing="0" class="search-form">
            <tbody>
            <tr>
                <td>
                    <div class="explain-col">
                        商品分类：
                        <select name="cate_id" id="cate_id" style="font-size:15px;">
                            <option value="0">--所有分类--</option>
                            <volist name="cate_list" id="val">
                                <option value="{$val.id}" level="{$val.level}" <if condition="$cate_id eq $val['id']"> selected="selected" </if>>
                                {:str_repeat('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',$val['level'])}
                                {:trim($val['name'])}
                                </option>
                            </volist>
                        </select>
                        &nbsp;&nbsp;品牌：
                        <select name="goods_brand" id="goods_brand">
                            <option value="{$active_brandId}">{$active_brandName}</option>
                        </select>
                        &nbsp;&nbsp;商品类型：
                        <select name="goods_type" id="goods_type">
                            <option value="0" <if condition="$type eq '0'">selected</if>>--选择--</option>
                            <option value="1" <if condition="$type eq '1'">selected</if>>商城商品</option>
                            <option value="2" <if condition="$type eq '2'">selected</if>>淘客商品</option>
                        </select>
                        <br/><br/>
                        添加时间：
                        <input type="text" name="goods_time_start" id="goods_time_start" class="date datetimepicker" size="20" value="" />
                        -
                        <input type="text" name="goods_time_end" id="goods_time_end" class="date datetimepicker" size="20" value="" />
                        &nbsp;&nbsp;价格区间：
                        <input type="text" name="price_start" id="price_start" size="12" value="" />
                        -
                        <input type="text" name="price_end" id="price_end" size="12" value="" />
                        &nbsp;&nbsp;商品名称：
                        <input name="goods_keyword" type="text" id="goods_keyword" class="input-text" size="25" value="{$keyword}" />
                        &nbsp;<input type="button" id="selectGoods_search" class="button" value="搜索" />
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="innerBox"></div>
    <div class="control">
        <div class="selectgoodsPage">
            <a href="javascript:;" class="selectgoodsPrevPage">上一页</a>
            <span class="selectgoodsNowpage">1</span>
            <a href="javascript:;" class="selectgoodsNextPage">下一页</a>
        </div>
        <input type="button" id="choiceThis" value="选中" data-type="goodssale" />
        <input type="button" id="cancel" value="取消" />
    </div>
</div>

<link href="__ROOT__/statics/admin/css/selectGoods.css" rel="stylesheet" type="text/css" />
<script src="__ROOT__/statics/admin/js/brandSelectGoods.js"></script>

<script type="text/javascript">
    var proChoiceWay = 4;
    var mutiChoice = true;
    var submitLock = true;

    Date.prototype.format = function(format) {
        var date = {
            "M+": this.getMonth() + 1,
            "d+": this.getDate(),
            "h+": this.getHours(),
            "m+": this.getMinutes(),
            "s+": this.getSeconds(),
            "q+": Math.floor((this.getMonth() + 3) / 3),
            "S+": this.getMilliseconds()
        };
        if (/(y+)/i.test(format)) {
            format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
        }
        for (var k in date) {
            if (new RegExp("(" + k + ")").test(format)) {
                format = format.replace(RegExp.$1, RegExp.$1.length == 1
                        ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
            }
        }
        return format;
    }

    //获取spu列表
    function getSpuList() {
        var d, html = '', $table = $("#skulist").find("tbody");
        $.get('?m=Brandgroup&a=getSpuList&topicId='+$("#rid").val(),function(data){
            for(var i=0;i< data.length;i++) {
                d = data[i];
                html += '<tr class="oldLine" data-spu="'+d.spu_id+'" data-rid="'+d.rid+'">';
                //设置淘客标识
                html += '<td align="center" width="50"><a href="javascript:;" class="delThis" data-id="'+d.spu_id+'">删除</a></td>';
                html += '<td align="center" width="80" data-taoke="'+d.istaoke+'" id="taoke'+d.spu_id+'">' +d.spu_id+ '</td>';
                html += '<td align="center">' +d.title+ '</td>';
                html += '<td align="center"><img src="'+d.image_src+'" width="80" /></td>';
                html += '<td align="center" width="50">' +d.cate+ '</td>';
                html += '<td align="center" width="50">';
                html += '<a href="javascript:;" class="upLineControl"><font color="blue">上移</font></a><br/>';
                html += '<a href="javascript:;" class="downLineControl"><font color="blue">下移</font></a>';
                html += '</td>';
                html += '<td width="45%"><div class="likeATable lat'+ d.spu_id +'" >';
                html += '<div class="row10">';
                html += '<div class="col2" align="center">SKU</div>';
                html += '<div class="col2" align="center">价格(元)</div>';
                html += '<div class="col2" align="center">销量(件)</div>';
                html += '<div class="col2" align="center">库存(件)</div>';
                html += '<div class="col2" class="hidepriceHead" align="center">活动价格(元)</div>';
                html += '<div class="col2" class="hidestockHead" align="center">活动库存(件)</div>';
                html += '</div>';
                html += '</div></td>';
                html += '</tr>';
            }
            $table.html(html);
            setTimeout(getSkuList,500);
        },'json');
    }

    function getSkuList() {
        var d, html;
        $.get('?m=Brandgroup&a=getSkuList&topicId='+$("#rid").val(),function(data){
            for(var i=0;i<data.length;i++) {
                html = '';
                d=data[i];
                //console.log(d);
                //console.log(d.spu_id, d.type, d.price, d.sale, d.stock, d.ex_price, d.ex_stock);
                if(d.taoke == 'yes') {
                    //淘客商品
                    html += '<div class="row10 childSku'+ d.spu_id+'" data-spu="'+d.spu_id+'">';
                    html += '<div align="center" class="col2 hideskuid a' +d.spu_id+ '" data-id="'+ d.id +'" data-type="'+ d.type+'" data-taoke="'+d.taoke+'">无</div>';
                    html += '<div align="center" class="col2 normalprice">'+d.price+'</div>';
                    html += '<div align="center" class="col2 hideatom b' +d.spu_id+ '">'+d.sale+'</div>';
                    html += '<div align="center" class="col2 e' +d.spu_id+ '">'+d.stock+'</div>';
                    //限时
                    if(d.type == '1') {
                        html += '<div class="col2 hideprice c' +d.spu_id+ '" align="center">'+d.ex_price+'</div>';
                        html += '<div class="col2 hidestock d' +d.spu_id+ '" align="center">'+d.ex_stock+'</div>';
                    } else if(d.type == '2') {
                        html += '<div class="col2 hideprice c' +d.spu_id+ '" align="center">'+d.ex_price+'</div>';
                        html += '<div class="col2 hidestock d' +d.spu_id+ '" align="center"></div>';
                    } else {
                        html += '<div class="col2 hideprice c' +d.spu_id+ '" align="center"></div>';
                        html += '<div class="col2 hidestock d' +d.spu_id+ '" align="center"></div>';
                    }
                    html += '</div>';
                } else {
                    html += '<div class="row10 childSku'+ d.spu_id+'" data-spu="'+d.spu_id+'">';
                    html += '<div align="center" class="col2 hideskuid a' +d.spu_id+ '" data-id="'+ d.id +'" data-type="'+ d.type+'" data-taoke="'+d.taoke+'">' + d.name+ '</div>';
                    html += '<div align="center" class="col2 normalprice">' + d.price + '</div>';
                    html += '<div align="center" class="col2 hideatom b' +d.spu_id+ '" data-id="'+d.atom_id+'">' + d.sale+ '</div>';
                    html += '<div align="center" class="col2 e' +d.spu_id+ '">' +d.stock+ '</div>';
                    if(d.type == '1') {
                        html += '<div class="col2 hideprice c' +d.spu_id+ '" align="center"><input type="text" value="'+ d.ex_price +'" disabled="disabled" /></div>';
                        html += '<div class="col2 hidestock d' +d.spu_id+ '" align="center"></div>';
                    } else if(d.type == '2') {
                        html += '<div class="col2 hideprice c' +d.spu_id+ '" align="center"><input type="text" value="'+ d.ex_price +'" disabled="disabled" /></div>';
                        html += '<div class="col2 hidestock d' +d.spu_id+ '" align="center"><input type="text" value="'+ d.ex_stock +'" disabled="disabled" /></div>';
                    } else {
                        html += '<div class="col2 hideprice c' +d.spu_id+ '" align="center"></div>';
                        html += '<div class="col2 hidestock d' +d.spu_id+ '" align="center"></div>';
                    }
                    html += '</div>';
                }
                //console.log(html);
                //console.log(".lat"+ d.spu_id);
                $(".lat"+ d.spu_id).append(html);
            }
        },'json')
    }

    $(function(){
        //取spu+sku
        getSpuList();

        $(document).on("click",".delThis",function(){
            var mySpu = $(this).closest("tr").attr("data-spu"),
                myClass = $(this).closest("tr").attr("class"),
                myTr = $("#skulist tr[data-spu='"+mySpu+"']");
            if(myClass && myClass.match('spuAdd') == 'spuAdd') {
                myTr.remove();
            } else {
                myTr.addClass("spuCut").hide();
            }
        });

        //表单提交
        $("#dosubmit").on("click",function(){
            var choiceTimeStart = $("#time_start").val();
            var choiceTimeEnd = $("#time_end").val();
            var choiceTimestampStart = Date.parse(choiceTimeStart)/1000;
            var choiceTimestampEnd = Date.parse(choiceTimeEnd)/1000;
            var nowTimestamp = Date.parse(new Date())/1000;
            var title = $("#title").val();
            //两个字段顺序错了，前端没改顺序，后端插入的顺序改了
            var desc = $("#desc").val();
            var provider = $("#provider").val();
            var lenClass = '', lenCount = 0;
            $("#skulist tbody tr").each(function(i){
                lenClass = $(this).attr("class");
                if(lenClass.match('spuCut') == 'spuCut') {

                } else {
                    lenCount ++;
                }
            });

            if(lenCount <= 0) {
                alert("商品必须添加。");
                return false;
            }
            if(!$("#spu").val()) {
                alert("请选择活动商品！");
                return false;
            }
            if(!title) {
                alert("请输入标题！");
                return false;
            }
            if(title.length > 12) {
                alert("标题不可超过12个字！");
                return false;
            }
            if(!desc) {
                alert("请输入副标题！");
                return false;
            }
            if(!provider) {
                alert("请输入折扣信息！");
                return false;
            }
            if(!choiceTimeStart) {
                alert("请选择上架时间！");
                return false;
            }
            if(!choiceTimeEnd) {
                alert("请选择下架时间！");
                return false;
            }
            if(choiceTimestampEnd < choiceTimestampStart) {
                alert("下架时间不可小于发布时间！");
                return false;
            }
            if(choiceTimestampEnd < nowTimestamp) {
                alert("下架时间不可小于当前时间！");
                return false;
            }
            var listdataArr = [], cutSpuArr = [], addSpuArr = [];
            var typeValue = $("#activeType").val();

            //验证库存和价格为0的情况
            var notempty = true;
            var myspu = '';

            var addLen = '';
            var spuLen = $("#skulist tbody tr.spuLine").length;
            var skuArr = [], spuArr = [];
            var defaultLen = $("#skulist tbody tr").length;
            var dskuArr = [];
            var dmyClass = '';
            var defaultArr = [];
//            //原有商品
//            for(var o=0;o<defaultLen;o++) {
//                dskuArr = [];
//                dmyClass = $("#skulist tbody tr").eq(o).attr("class");
//                if(!dmyClass) {
//                    defaultArr.push({
//                        'atom_id' : $("#skulist tbody tr").eq(o).find(".hideatom").attr("data-id"),
//                        'start_time' : $("#time_start").val(),
//                        'end_time' : $("#time_end").val(),
//                        'taoke' : $("#skulist tbody tr").eq(o).find(".hideskuid").attr("data-taoke")
//                        //'price' : $("#skulist tbody tr").eq(o).find(".hideprice input").val(),
//                        //'stock' : $("#skulist tbody tr").eq(o).find(".hidestock input").val()
//                    })
//                }
//            }
            $(".oldLine").each(function(i){
                var delst = $(this).attr("data-del");
                if(!delst) {
                    //没被删除的
                    defaultArr.push({
                        'spu_id'     : $(this).attr("data-spu"),
                        'start_time' : $("#time_start").val(),
                        'end_time'   : $("#time_end").val(),
                        'sort'       : $(this).index(),
                        //'atom_id'    : $("#skulist tbody tr").eq(o).find(".hideatom").attr("data-id"),
                        'taoke'      : $(this).find(".hideskuid").eq(0).attr("data-taoke")
                    })
                }
            });

            var cutClass = '';
            var addLock = true;
            //新增商品
            $("#skulist tbody .spuLine").each(function(k){
                var self = $(this);
                skuArr = [];
                spuId = $(this).attr("data-spu");
                trLen = $(".a"+spuId).length;

                for(var i=0; i<trLen; i++) {
                    exprice     = self.find(".c"+spuId).eq(i).find("input").val();
                    exstock     = self.find(".d"+spuId).eq(i).find("input").val();
                    normalstock = self.find(".e"+spuId).eq(i).text();

                    console.log(typeValue);

                    //限时要验活动价
                    if(typeValue == '1') {
                        //限时验活动价
                        if (exprice == '0') {
                            alert("活动价格不能为0");
                            addLock = false;
                            return false;
                        }
                    }
                    //限时限量要验库存
                    if (typeValue == '2') {
                        if (exprice == '0') {
                            alert("活动价格不能为0");
                            addLock = false;
                            return false;
                        }
                        if (exstock == '0') {
                            alert("活动库存不能为0");
                            addLock = false;
                            return false;
                        }
                        if (parseInt(exstock) > parseInt(normalstock)) {
                            alert("活动库存不可大于实际库存");
                            addLock = false;
                            return false;
                        }
                    }
                    skuArr.push({
                        skuid : self.find(".a"+spuId).eq(i).attr("data-id"),         //sku
                        sale  : self.find(".b"+spuId).eq(i).text(),                  //销量
                        price : self.find(".c"+spuId).eq(i).find("input").val(),     //价格
                        stock : typeValue == '1' ? (normalstock) : (exstock),        //库存
                        type  : typeValue
                    });
                }
                //组合relation信息
                addSpuArr.push({
                    index      : $(this).index(),
                    id         : spuId,
                    time_start : $("#time_start").val(),
                    time_end   : $("#time_end").val(),
                    sort       : $(this).index(), //做到这了
                    type       : '2',                               //2:品牌团
                    image_src  : $("#image_src").val(),
                    sku        : skuArr,
                    //该spu是否淘客
                    taoke      : $("#taoke"+spuId).attr("data-taoke") ? $("#taoke"+spuId).attr("data-taoke") : 'no'
                });
            });

            if(!addLock) {
                return false;
            }

//            for(var i=0;i<spuLen;i++) {
//                cutClass = $("#skulist tbody tr.spuLine").eq(i).attr("class");
//                if(cutClass.indexOf('spuCut') < 0) {
//                    spuId = $("#skulist tbody tr.spuLine").eq(i).attr("data-spu");
//                    addLen = $(".spuAdd[data-spu='"+spuId+"']").length;
//                    skuArr = [];
//                    for(var j=0;j<addLen;j++) {
//                        //源头
//                        exprice     = $("#skulist tbody tr").find(".c"+spuId).eq(j).find("input").val();
//                        exstock     = $("#skulist tbody tr").find(".d"+spuId).eq(j).find("input").val();
//                        normalstock = $("#skulist tbody tr").find(".e"+spuId).eq(j).text();
//                        //限时要验活动价
//                        if(typeValue == '1') {
//                            //限时验活动价
//                            if (exprice == '0') {
//                                alert("活动价格不能为0");
//                                return false;
//                            }
//                        }
//                        //限时限量要验库存
//                        if (typeValue == '2') {
//                            if (exprice == '0') {
//                                alert("活动价格不能为0");
//                                return false;
//                            }
//                            if (exstock == '0') {
//                                alert("活动库存不能为0");
//                                return false;
//                            }
//                            if (parseInt(exstock) > parseInt(normalstock)) {
//                                alert("活动库存不可大于实际库存");
//                                return false;
//                            }
//                        }
//                        //sku
//                        skuArr = {
//                            skuid : $("#skulist tbody tr").find(".a"+spuId).eq(j).attr("data-id"),         //sku
//                            sale  : $("#skulist tbody tr").find(".b"+spuId).eq(j).text(),                  //销量
//                            price : $("#skulist tbody tr").find(".c"+spuId).eq(j).find("input").val(),     //价格
//                            stock : typeValue == '1' ? (normalstock) : (exstock),                          //库存
//                            type  : typeValue
//                        };
//                        //组合活动信息
//                        addSpuArr.push({
//                            id         : spuId,
//                            time_start : $("#time_start").val(),
//                            time_end   : $("#time_end").val(),
//                            sort       : $("#sort").val(),              //弃用该字段，改用创建时间排序
//                            type       : typeValue,                       //2:走extend_sepcial
//                            //image_src是新增地址 image_upyun是又拍云原有地址
//                            image_src  : $("#image_src").val(),
//                            image_upyun: $(".image_box img").attr("src"),
//                            sku        : skuArr,
//                            //该spu是否淘客
//                            taoke      : $("#taoke"+spuId).attr("data-taoke") ? $("#taoke"+spuId).attr("data-taoke") : 'no'
//                        });
//                    }
//                }
//            }
            //删除商品
            $(".spuCut").each(function(i) {
                var topicId = $("#rid").val(),
                    rid = $(this).closest("tr").attr("data-rid"),
                    spuId  = $(this).find(".delThis").attr("data-id"),
                    cutSkuList = [];
                $('.childSku'+spuId).each(function(j){
                    cutSkuList.push({
                        skuId  : $(this).find(".hideskuid").attr("data-id"),
                        taoke  : $(this).find(".hideskuid").attr("data-taoke"),
                        atomId : $(this).find(".hideatom").attr("data-id"),
                        type   : $(this).find(".hideskuid").attr("data-type")
                    })
                });
                cutSpuArr.push({
                    rid : rid,
                    topicId : topicId,
                    spuId  : spuId,
                    skuList : cutSkuList
                });
            });

            if(!notempty) {
                return false;
            }
            var addData = {
                topic_id   : $("#rid").val(),
                spu        : $("#spu").val(),
                title      : $("#title").val(),
                desc       : $("#desc").val(),      //描述
                provider   : $("#provider").val(),  //折扣
                time_start : $("#time_start").val(),
                time_end   : $("#time_end").val(),
                sort       : $("#sort").val(),
                image_src  : $("#image_src").val(),
                collection : defaultArr,
                cutSpu     : cutSpuArr,
                addSpu     : addSpuArr
            };

            if(submitLock) {
                submitLock = false;
                $.ajax({
                    type     : "POST",
                    url      : "admin.php?m=Brandgroup&a=save",
                    data     : addData,
                    dataType : "json",
                    success  : function(d){
                        alert(d.msg);
                        if(d.flag) {
                            window.location.href = "admin.php?m=Brandgroup&a=index";
                        }
//                        else {
//                            submitLock = true;
//                        }
                    },
                    error : function(){
                        //submitLock = true;
                    }
                })
            }
        })

        $('.datetimepicker').datetimepicker({value:'',step:"30"});
    })
</script>
</body></html>