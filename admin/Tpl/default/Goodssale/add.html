<include file="Public:header" />
<style>
    *{margin:0;padding:0;}
    .fileControl{
        padding:5px;
    }
    .vqdTrigger{
        width:60px;
        height:25px;
        line-height:25px;
        text-align:center;
        border-radius:2px;
        background:#CC290E;
        color:#FFF;
        font-size:12px;
        border:none;
        cursor:pointer;
        outline:none;
    }
    #vqdfile{
        position:absolute;
        opacity:0;
    }
    .fileList li{
        position:relative;
        margin-top:5px;
        height:50px;
        padding:6px;
        display:block;
        border:1px solid #CCC;
        border-radius:4px;
    }
    .fileList li img{
        float:left;
        height:50px;
        display:block;
    }
    .fileList li .del{
        position:absolute;
        right:5px;
        top:20px;
        width:18px;
        height:18px;
        line-height:19px;
        text-align:center;
        border:1px solid #CCC;
        border-radius:20px;
        text-decoration:none;
        color:#888;
        font-size:16px;
    }
    #div_setting_2,#div_setting_3 {
        border:1px solid #dce3ed;
    }
    .col-tab ul.tabBut {
        bottom:-11px;
    }
    ul li{
        list-style:none;
    }
    .flyCheckBox{
        width:140px;
        height:35px;
        border:1px solid #CCC;
        border-radius:6px;
        cursor:pointer;
        background:#F4F4F4;
        outline:none;
        padding:0 5px;
        float:left;
    }
    .flyBox{
        position:fixed;
        left:25%;
        right:25%;
        top:10%;
        max-height:320px;
        overflow:hidden;
        z-index:1000;
        padding:10px 20px 45px 20px;
        border-radius:4px;
        background:#FFF;
        border:1px solid #CCC;
        display:none;
    }
    .flyBox label{
        margin-top:5px;
        padding-bottom:5px;
        width:100%;
        height:14px;
        line-height:14px;
        display:block;
        border-bottom:1px dashed #ccc;
    }
    .flyBox input[type='checkbox']{
        float:left;
        margin-right:5px;

    }
    #to_id{
        width:100%;
        height:100%;
        min-height:200px;
        max-height:250px;
        overflow:scroll;
        overflow-x:hidden;
    }
    .flyBox .foot{
        width:100%;
        padding:10px 0;
        height:21px;
        text-align:center;
        position:absolute;
        bottom:0;
        left:0;
        background:#f4f4f4;
    }
    .flyBox .head{
        margin-bottom:20px;
        width:100%;
        height:21px;
    }
    .flyBox .flyBox_close{
        font-size:16px;
        float:right;
        text-decoration:none;
    }
    .flyBox .iframe{

    }
    .chk_submit .chk_reset{
        width:60px;
        height:22px;
        background:#CCC;
        border:1px solid #CCC;
        border-radius:2px;
        display:inline-block;
        cursor:pointer;
    }
    .flyBox_trigger{
        width:60px;
        height:37px;
        margin-right:10px;
        float:left;
        border-radius:4px;
        border:1px solid #CCC;
        background:#f4f4f4;
        text-align:center;
        cursor:pointer;
        color:#555;
    }
</style>
<link rel="stylesheet" type="text/css" href="__ROOT__/statics/admin/css/jquery.datetimepicker.css"/>
<script type="text/javascript" src="__ROOT__/statics/admin/js/jquery.datetimepicker.js"></script>
<script type="text/javascript" src="__ROOT__/statics/js/jquery/plugins/jquery.imagePreview.js"></script>
<script src="__ROOT__/statics/lib/uploadify/jquery.uploadify.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="__ROOT__/statics/lib/uploadify/uploadify.css">
<script src="__ROOT__/statics/admin/js/jquerysession.js"></script>


<style>
    .groupChoice{
        position:fixed;
        width:80%;
        left:10%;
        top:50px;
        height:388px;
        background:#fff;
        z-index:288;
        display:none;
        border:1px solid #ccc;
    }
    .fullscreen_shadow{
        position:fixed;
        left:0;
        top:0;
        bottom:0;
        right:0;
        background:rgba(0,0,0,0.5);
        width:100%;
        height:100%;
        z-index:266;
        display:none;
    }
    .groupChoice .iframe{
        border:none;
        width:100%;
        height:350px;
    }
    .groupChoice .control{
        width:100%;
        height:38px;
        text-align:center;
    }
    /* 列表隐藏的列 */
    .hideprice,.hidestock,.hidepriceHead,.hidestockHead{
        display:none;
    }
    .hideprice input,.hidestock input{
        border:none;
        background:none;
        width:80px;
        height:32px;
        line-height:32px;
        text-align:center;
        border:1px solid #ccc;
        outline:none;
    }
</style>
<div class="fullscreen_shadow"></div>


<div style="padding:10px">
    <div class="col-tab">
        <form action="admin.php?m=Goodssale&a=add" method="post" name="myform" id="myform" enctype="multipart/form-data" style="margin-top:10px;">
            <div id="div_setting_1" class="contentList pad-10">
                <table width="100%" cellpadding="2" cellspacing="1" class="table_form">
                    <!-- 关联商品SPU -->
                    <input type="hidden" name="spu" id="spu" value="" />
                    <!-- 是否淘客 -->
                    <input type="hidden" name="taoke" id="taoke" value="" />
                    <!-- 活动类型 -->
                    <input type="hidden" name="type" id="typeChangeValue" />

                    <tbody id="item_body">
                        <tr>
                            <td width="100">活动类型 :</td>
                            <td>
                                <select name="type" id="typeChange">
                                    <option value="1">限时</option>
                                    <option value="2">限时限量</option>
                                </select>
                            </td>
                        </tr>
                        <tr class="tab1">
                            <td>选择商品 :</td>
                            <td>
                                <input type="text" class="flyCheckBox" id="group_show_value" name="activity" />
                                <input type="button" class="flyBox_trigger" id="select_group" value="选择商品" data-type="timelimit" />
                            </td>
                        </tr>
                        <tr>
                            <td>上架时间 :</td>
                            <td>
                                <input type="text" name="time_start" id="time_start" class="date datetimepicker" size="20" value="{$time_start}">
                            </td>
                        </tr>
                        <tr>
                            <td>下架时间 :</td>
                            <td>
                                <input type="text" name="time_end" id="time_end" class="date datetimepicker" size="20" value="{$end_start}">
                            </td>
                        </tr>
                        <!-- 运营不要这个，先注释，搞不好哪天就要了呢...
                        <tr>
                            <td>活动顺序 :</td>
                            <td>
                                <input type="text" name="sort" id="sort" value="0" />
                            </td>
                        </tr>
                        -->
                    </tbody>
                </table>
                <div class="table-list" id="skulist">
                    <table width="100%" cellspacing="0" class="tb_rec">
                        <thead>
                        <tr>
                            <th align="center">商品编号</th>
                            <th align="center">商品标题</th>
                            <th align="center">商品图片</th>
                            <th align="center">分类</th>
                            <th align="center">SKU</th>
                            <th align="center">价格(元)</th>
                            <th align="center">销量(件)</th>
                            <th align="center">库存(件)</th>
                            <th class="hidepriceHead" align="center">活动价格(元)</th>
                            <th class="hidestockHead" align="center">活动库存(件)</th>
                            <!--<th>操作</th>-->
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

                <div class="bk15"></div>
                <div class="btn"><input type="button" value="{$Think.lang.submit}" name="dosubmit" class="button" id="dosubmit"></div>
            </div>
        </div>
    </form>

</div>

<div class="fullscreen_shadow"></div>
<div class="selectGoods">
    <div class="search">
        <table width="100%" cellspacing="0" class="search-form">
            <tbody>
            <tr>
                <td>
                    <div class="explain-col">
                        商品分类：
                        <select name="cate_id" id="cate_id" style="font-size:15px;">
                            <option value="0">--所有分类--</option>
                            <volist name="cate_list" id="val">
                                <option value="{$val.id}" level="{$val.level}" <if condition="$cate_id eq $val['id']"> selected="selected" </if>>
                                {:str_repeat('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',$val['level'])}
                                {:trim($val['name'])}
                                </option>
                            </volist>
                        </select>
                        &nbsp;&nbsp;品牌：
                        <select name="goods_brand" id="goods_brand">
                            <option value="">--选择--</option>
                            <volist name="brand_list" id="val">
                                <option value="{$val.id}" <if condition="$brand_id eq $val['id']"> selected="selected" </if>>{$val.name}</option>
                            </volist>
                        </select>
                        &nbsp;&nbsp;商品类型：
                        <select name="goods_type" id="goods_type">
                            <option value="0" <if condition="$type eq '0'">selected</if>>--选择--</option>
                            <option value="1" <if condition="$type eq '1'">selected</if>>商城商品</option>
                            <option value="2" <if condition="$type eq '2'">selected</if>>淘客商品</option>
                        </select>
                        <br/><br/>
                        添加时间：
                        <input type="text" name="goods_time_start" id="goods_time_start" class="date datetimepicker" size="20" value="" />
                        -
                        <input type="text" name="goods_time_end" id="goods_time_end" class="date datetimepicker" size="20" value="" />
                        &nbsp;&nbsp;价格区间：
                        <input type="text" name="price_start" id="price_start" size="12" value="" />
                        -
                        <input type="text" name="price_end" id="price_end" size="12" value="" />
                        &nbsp;&nbsp;商品名称：
                        <input name="goods_keyword" type="text" id="goods_keyword" class="input-text" size="25" value="{$keyword}" />
                        &nbsp;<input type="button" id="selectGoods_search" class="button" value="搜索" />
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="innerBox"></div>
    <div class="control">
        <div class="selectgoodsPage">
            <a href="javascript:;" class="selectgoodsPrevPage">上一页</a>
            <span class="selectgoodsNowpage">1</span>
            <a href="javascript:;" class="selectgoodsNextPage">下一页</a>
        </div>
        <input type="button" id="choiceThis" value="选中" data-type="goodssale" />
        <input type="button" id="cancel" value="取消" />
    </div>
</div>

<link href="__ROOT__/statics/admin/css/selectGoods.css" rel="stylesheet" type="text/css" />
<script src="__ROOT__/statics/admin/js/selectGoods.js"></script>

<script type="text/javascript">

    Date.prototype.format = function(format) {
        var date = {
            "M+": this.getMonth() + 1,
            "d+": this.getDate(),
            "h+": this.getHours(),
            "m+": this.getMinutes(),
            "s+": this.getSeconds(),
            "q+": Math.floor((this.getMonth() + 3) / 3),
            "S+": this.getMilliseconds()
        };
        if (/(y+)/i.test(format)) {
            format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
        }
        for (var k in date) {
            if (new RegExp("(" + k + ")").test(format)) {
                format = format.replace(RegExp.$1, RegExp.$1.length == 1
                        ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
            }
        }
        return format;
    }

    var mutiChoice = true;    // true:多选 false:单选
    var proChoiceWay = '2';     // 1:每日上新 2:特卖 3:品牌团
    var submitLock = true;

    $(function(){

        $("#typeChange").on("change",function(){
            var myst = $(this).find("option:selected").val();
            var meStock = $(".hidestock,.hidestockHead"),
                mePrice = $(".hideprice,.hidepriceHead");
            if(myst == 0) {
                mePrice.hide();
                meStock.hide();
            } else if(myst == 1) {
                mePrice.show();
                meStock.hide();
            } else if(myst == 2) {
                mePrice.show();
                meStock.show();
            }
        });

        //表单提交
        $("#dosubmit").on("click",function(){
            var choiceTimeStart = $("#time_start").val();
            var choiceTimeEnd = $("#time_end").val();
            var choiceTimestampStart = Date.parse(choiceTimeStart)/1000;
            var choiceTimestampEnd = Date.parse(choiceTimeEnd)/1000;
            var nowTimestamp = Date.parse(new Date())/1000;

            var spu = $("#spu").val();
            var image_src = $("#image_src").val();
            //var sort = $("#sort").val() ? $("#sort").val() : 0;
            //8.1 改变取值目标
            var typeValue = $("#typeChangeValue").val();

            if(!spu) {
                alert("请选择活动商品！");
                return false;
            }
            if(!typeValue) {
                alert("请选择活动类型");
                return false;
            }
            /*
            if(!image_src){
                alert("图片不能为空");
                return false;
            }
            */
            if(!choiceTimeStart) {
                alert("请选择上架时间！");
                return false;
            }
            if(!choiceTimeEnd) {
                alert("请选择下架时间！");
                return false;
            }
            if(choiceTimestampStart < nowTimestamp) {
                alert("发布时间不可小于当前时间！");
                return false;
            }
            if(choiceTimestampEnd < choiceTimestampStart) {
                alert("下架时间不可小于发布时间！");
                return false;
            }
            if(choiceTimestampEnd < nowTimestamp) {
                alert("下架时间不可小于当前时间！");
                return false;
            }

            var listdataArr = [];
            var stockValue, saleValue;

            var spuId = $("#spu").val();
            var spuIdArr = new Array();

            spuIdArr = spuId.split(",");

            var spuId, skuArr, dataArr = [], trLen = 0;

            var exprice, exstock, normalstock;

            for(var j=0; j<spuIdArr.length; j++) {
                skuArr = [];
                spuId = spuIdArr[j];
                trLen = $(".a"+spuId).length;
                //组合SKU信息
                for(var i=0; i<trLen; i++) {
                    exprice     = $("#skulist tbody tr").find(".c"+spuId).eq(i).find("input").val();
                    exstock     = $("#skulist tbody tr").find(".d"+spuId).eq(i).find("input").val();
                    normalstock = $("#skulist tbody tr").find(".e"+spuId).eq(i).text();
                    //限时要验活动价
                    if(typeValue == '1') {
                        //限时验活动价
                        if (exprice == '0') {
                            alert("活动价格不能为0");
                            return false;
                        }
                    }
                    //限时限量要验库存
                    if (typeValue == '2') {
                        if (exprice == '0') {
                            alert("活动价格不能为0");
                            return false;
                        }
                        if (exstock == '0') {
                            alert("活动库存不能为0");
                            return false;
                        }
                        if (parseInt(exstock) > parseInt(normalstock)) {
                            alert("活动库存不可大于实际库存");
                            return false;
                        }
                    }
                    skuArr.push({
                        skuid : $("#skulist tbody tr").find(".a"+spuId).eq(i).attr("data-id"),         //sku
                        sale  : $("#skulist tbody tr").find(".b"+spuId).eq(i).text(),                  //销量
                        price : exprice,                                                               //价格
                        stock : typeValue == '1' ? (normalstock) : (exstock),                          //库存
                        type  : typeValue
                    });
                }
                //组合活动信息，以spu为单位
                dataArr.push({
                    id         : spuId,
                    time_start : $("#time_start").val(),
                    time_end   : $("#time_end").val(),
                    //sort       : sort,
                    sort       : '0',
                    type       : '2',                    //2:走extend_sepcial
                    image_src  : image_src,
                    sku        : skuArr,
                    //该spu是否淘客
                    taoke      : $("#taoke"+spuId).attr("data-taoke") ? $("#taoke"+spuId).attr("data-taoke") : 'no'
                });
            }
            if(submitLock) {
                submitLock = false;
                $.ajax({
                    type     : "POST",
                    url      : "admin.php?m=Goodssale&a=add",
                    data     : {
                        dosubmit : $("#dosubmit").val(),
                        info     : dataArr
                    },
                    dataType : "json",
                    success  : function(d){
                        alert(d.msg);
                        //submitLock = true;
                        if(d.flag) {
                            window.location.href = "admin.php?m=Goodssale&a=index";
                        }
                    },
                    error : function(){
                        submitLock = true;
                    }
                })
            }
        })

        $('.datetimepicker').datetimepicker({value:'',step:"30"});
    })
</script>
</body>
</html>