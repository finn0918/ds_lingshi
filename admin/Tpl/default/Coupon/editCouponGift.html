<include file="Public:header" />
<style>
			*{
				margin:0;
				padding:0;
			}
			.fileControl{
				position:relative;
				padding:5px;
			}
			.vqdTrigger{
				position:relative;
				width:60px;
				height:25px;
				line-height:25px;
				text-align:center;
				border-radius:4px;
				background:#CC290E;
				color:#FFF;
				font-size:12px;
				border:none;
				cursor:pointer;
				outline:none;
			}
			.vqdfile{
				position:absolute;
				opacity:0;
			}
			.fileList li{
				position:relative;
				margin-top:5px;
				height:50px;
				padding:6px;
				display:block;
				border:1px solid #CCC;
				border-radius:4px;
			}
			.fileList li img{
				float:left;
				height:50px;
				display:block;
			}
			.fileList li .del{
				position:absolute;
				right:5px;
				top:20px;
				width:18px;
				height:18px;
				line-height:19px;
				text-align:center;
				border:1px solid #CCC;
				border-radius:20px;
				text-decoration:none;
				color:#888;
				font-size:16px;
			}
			.uploadSubmit{
				position:absolute;
				left:70px;
				top:5px;
				z-index:8;
				width:60px;
				height:25px;
				line-height:25px;
				text-align:center;
				border-radius:4px;
				background:#58BC40;
				color:#FFF;
				font-size:12px;
				border:none;
				cursor:pointer;
				outline:none;
				display:none;
			}

<!-- 我的添加-->
           ul li{
	             list-style:none;
            }
           .flyCheckBox{
	             width:140px;
	             height:35px;
	             border:1px solid #CCC;
	             border-radius:6px;
	             cursor:pointer;
	             background:#F4F4F4;
	             outline:none;
	             padding:0 5px;
	             float:left;
              }
            .flyBox{
	             position:fixed;
	             left:25%;
	             right:25%;
	             top:10%;
            	 max-height:320px;
            	 overflow:hidden;
	             z-index:1000;
	             padding:10px 20px 45px 20px;
	             border-radius:4px;
	             background:#FFF;
	             border:1px solid #CCC;
	             display:none;
              }
             .flyBox label{
	             margin-top:5px;
	             padding-bottom:5px;
	             width:100%;
             	 height:14px;
	             line-height:14px;
	             display:block;
	             border-bottom:1px dashed #ccc;
               }
               .flyBox input[type='checkbox']{
               	float:left;
               	margin-right:5px;

               }
               #to_id{
				width:100%;
               	height:100%;
               	min-height:200px;
               	max-height:250px;
               	overflow:scroll;
               	overflow-x:hidden;
               }
             .flyBox .foot{
	             width:100%;
	             padding:10px 0;
             	 height:21px;
	             text-align:center;
             	 position:absolute;
             	 bottom:0;
             	 left:0;
             	 background:#f4f4f4;
               }
               .flyBox .head{
				margin-bottom:20px;
				width:100%;
               	height:21px;
               }
               .flyBox .flyBox_close{
					font-size:16px;
               		float:right;
               	text-decoration:none;
               }
             .chk_submit .chk_reset{
	             width:60px;
	             height:22px;
	             background:#CCC;
	             border:1px solid #CCC;
	             border-radius:2px;
	             display:inline-block;
	             cursor:pointer;
                }
                .flyBox_trigger{
                	width:60px;
                	height:37px;
                	margin-right:10px;
                	float:left;
                	border-radius:4px;
                	border:1px solid #CCC;
                	background:#f4f4f4;
                	text-align:center;
                	cursor:pointer;
                	color:#555;
                }
		</style>
<script type="text/javascript" src="__ROOT__/includes/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="__ROOT__/includes/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript" src="__ROOT__/statics/js/jquery/plugins/jquery.imagePreview.js"></script>
<link rel="stylesheet" type="text/css" href="__ROOT__/statics/admin/css/jquery.datetimepicker.css"/>
<script type="text/javascript" src="__ROOT__/statics/admin/js/jquery.datetimepicker.js"></script>
<div class="flyBox">
	<div class="head"><a href="javascript:;" class="flyBox_close">×</a></a></div>
    <div id="to_id">
	</div>
	<div class="foot">
		<input type="button" class="chk_submit" value="确定" />
		<input type="button" class="chk_reset" value="清除" />
	</div>
</div>
<form action="{:u('Coupon/editCoupongift')}" method="post" name="myform" onsubmit="return submitOnce(this)" id="myform" enctype="multipart/form-data" style="margin-top:10px;">
  <div class="pad-10">
    <div class="col-tab">
       <ul class="tabBut cu-li">
			<li id="tab_setting_1" class="on" onclick="SwapTab('setting','on','',3,1);">新增优惠券大礼包</li>
      </ul>
      <div id="div_setting_1" class="contentList pad-10">
        <table width="100%" cellpadding="2" cellspacing="1" class="table_form">
            <input type="hidden" name="id" value="{$giftResult.id}">
          <tbody id="item_body">
          <tr>
            <th width="100">优惠券大礼包活动名称 :</th>
            <td><input type="text" name="name" id="name" class="input-text" size="60" value="{$giftResult.title}"></td>
          </tr>
          <tr>
              <th width="150">优惠券大礼包活动配图 :</th>
              <td>
                  <div id="form1">
                      <div class="fileControl">
                          <img src="{$giftResult.img}" width="60">
                          <input type="button" class="vqdTrigger" value="修改图片" />
                          <input type="file" class="vqdfile" multiple="multiple" />
                      </div>
                      <ul class="fileList"></ul>
                  </div>
              </td>
          </tr>
          <tr>
              <th>选择优惠券 ：
          </th>
              <td>
                  &nbsp;<input type="button" class="vqdTrigger selectCoupon" value="优惠券" />
              </td>
          </tr>
          <tr>
            <th>优惠券大礼包活动详情 :</th>
            <td><textarea name="detail" id="detail" cols="70" rows="10">{$giftResult.detail}</textarea></td>
          </tr>
          <table width="100%" cellpadding="2" cellspacing="1" class="table_form coupon">
              <thead>
              <tr>
                  <td align="center">优惠券编号</td>
                  <td align="center">优惠券标题</td>
                  <td align="center">发放张数</td>
                  <td align="center">操作</td>
              </tr>
              </thead>
              <tbody id="insert">
                {$table}
              </tbody>
          </table>
           <tr>
           <th>
            <input type="submit" onclick="return checkSubmit()" value="立刻发布" name="dosubmit" class="button" id="dosubmit"></div>
    		</th>
    		</tr>
          </table>
		</div>
  </div>
</form>
<script>

     function setVal(){
	    var self = $(".flyCheckBox"),
		box = $(".flyBox"),
		len = box.find("input[type='checkbox']").length,
		myVal = '',
		i = 0,
		arr = [];
	    len>0 && (box.find("input[type='checkbox']:checked").each(
		function(i){
			arr.push($(this).val());
		}
	     ),myVal = arr.join(","),self.val(myVal),box.hide());
      };
     function clearVal(){
	    var box = $(".flyBox"), len = box.find("input[type='checkbox']:checked").length;
	    len>0 && box.find("input[type='checkbox']:checked").each(function(){
		$(this).attr("checked",false);
	    });
      };
</script>

<script type="text/javascript">
    var gift = {$giftResult['id']};
$(function(){
    //var gift = {$giftResult['id']};
    $('.datetimepicker').datetimepicker({value:'',step:"30"});
    setTimeout(function(){$.get("?m=Coupon&a=getTable&gift="+gift,function(data){
        document.getElementById("insert").innerHTML = data.data;
    })}, 200);
    $(".selectCoupon").on("click",function(){
        var lang_edit = "新增优惠券大礼包的优惠券";
        window.top.art.dialog({id:'couponList'}).close();
        window.top.art.dialog({title:'新增优惠券大礼包的优惠券',id:'couponList',iframe:'?m=Coupon&a=couponList',width:'900',height:'580'},
                function(){
                    var d = window.top.art.dialog({id:'couponList'}).data.iframe;
                    d.document.getElementById('myforms').submit();
                    setTimeout(function(){$.get('?m=Coupon&a=getTable&gift='+gift,function(data){
                        document.getElementById("insert").innerHTML = data.data;
                        window.top.art.dialog({id:'couponList'}).close();
                    })}, 500);
                    return false;
                }, function(){window.top.art.dialog({id:'couponList'}).close();});
    });
})
function delCoupon(id){
    $.get('?m=Coupon&a=getTable&id='+id+'&gift='+gift,function(data){
        document.getElementById("insert").innerHTML = data.data;
    });
}
$(function(){
		    $.formValidator.initConfig({
		        formid:"myform",
		        autotip:true,
		        onerror:function(msg,obj){
		            window.top.art.dialog({
		                content:msg,
		                lock:true,
		                width:'250',
		                height:'50'}, function(){
		                    this.close();$(obj).focus();
		                    submitone =false;
		                    })}});

		    $("#name").formValidator({
		        onshow:"输入优惠券大礼包名称，不能为空",
		        onfocus:"不能为空"
		        }).inputValidator({
		            min:1,
		            onerror:"输入优惠券大礼包名称"
		            });
		})
</script>
<script>
			(function($) {
				$.fn.upload = function(options) {
					var opts = $.extend({}, $.fn.upload.defaults, options);
					return this.each(function() {
						var $this = $(this);
						var o = $.meta ? $.extend({}, opts, $this.data()) : opts;
						var index = 0;
						var father = o.self;
						var del = "#" + o.self + " .del";
						var trigger = "#" + o.self + " .vqdTrigger";
						var fileInput = "#" + o.self + " .vqdfile";
						//event
						$("body").on("click",del,{m:father},fileDel);
						$("body").on("change",fileInput,{m:father,f:o.fileName},fileTrigger);
						$("body").on("click",trigger,{m:father},fileClick);
					});
				};
				function fileClick(e){
					var self = e.data.m;
					$("#"+self+" .vqdfile").trigger("click");
				};
				function fileTrigger(e){
					var master = $("#"+e.data.m);
					var filename = e.data.f;
					var self = $(this)[0];
					var myfile = self.files;
					var myfileLen = myfile.length;
					var reader = new FileReader();
					var fileHiddenHtml;
					var fileHtml = '<input type="file" multiple="multiple" class="vqdfile" />';
					var replace = function(i){
						var index = i ? i : 0;
						var fileListHtml = '';
						if(index < myfileLen){
							console.log(index,myfileLen);
							reader.readAsDataURL(myfile[index]);
							reader.onload = function(e) {
								fileHiddenHtml = '<input type="hidden" name="'+filename+'[]" class="fileHidden" data-index="'+index+'" value="'+e.target.result+'" />';

								fileListHtml += '<li>';
								fileListHtml += '<img src="'+e.target.result+'" />';
								fileListHtml += '<a href="javascript:;" class="del" data-id="'+index+'">×</a>';
								fileListHtml += '</li>';

								master.find(".fileControl").append(fileHiddenHtml);
								master.find(".fileList").append(fileListHtml);
								master.find(".uploadSubmit").show();

								//fileArr.push(e.target.result);
								index++;
								replace(index);
							}
						}else{
							master.find(".vqdfile").remove();
							master.find(".fileControl").append(fileHtml);
							index = 0;
							console.log("上传成功");
						}
					};
					replace();
				};
				function fileDel(e){
					var master = $("#"+e.data.m),
						$self = $(this),
						selfLi = $self.closest("li"),
						selfIndex = $self.attr("data-id"),
						liLen = master.find(".fileList li").length;

					liLen <= 1 && master.find(".uploadSubmit").hide();
					//var changeArr = [];
					//for(var i in fileArr){
					//	if(i != selfIndex){
					//		changeArr.push(fileArr[i]);
					//	}
					//}
					master.find(".fileHidden[data-index="+selfIndex+"]").remove();
					//fileArr = changeArr;
					selfLi.remove();
				};
				// defaults
				$.fn.upload.defaults = {
					self : "",
					fileName : "file",
				};
			})(jQuery);
			$("#form1").upload({self:"form1"});
		</script>
</body></html>